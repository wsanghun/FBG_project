<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/mainlayout}">

<div layout:fragment="content">

    <link rel="stylesheet" th:href="@{/css/games-filter.css}">

    <div class="filter-page-container">

        <div class="filter-header">
            <h2>상세 검색</h2>
            <button type="button" class="reset-btn" onclick="resetFilters()">초기화</button>
        </div>

        <!-- ================== 필터 영역 ================== -->
        <form id="filterForm">

            <!-- 카테고리 -->
            <div class="filter-section">
                <h3>카테고리</h3>
                <label><input type="checkbox" name="category" value="전략"> 전략</label>
                <label><input type="checkbox" name="category" value="가족"> 가족</label>
                <label><input type="checkbox" name="category" value="파티"> 파티</label>
                <label><input type="checkbox" name="category" value="추상"> 추상</label>
                <label><input type="checkbox" name="category" value="어린이"> 어린이</label>
            </div>

            <!-- 테마 -->
            <div class="filter-section">
                <h3>테마</h3>
                <label><input type="checkbox" name="theme" value="동물"> 동물</label>
                <label><input type="checkbox" name="theme" value="판타지"> 판타지</label>
                <label><input type="checkbox" name="theme" value="SF"> SF</label>
                <label><input type="checkbox" name="theme" value="경제"> 경제</label>
                <label><input type="checkbox" name="theme" value="전쟁"> 전쟁</label>
                <label><input type="checkbox" name="theme" value="모험"> 모험</label>
            </div>

            <!-- 언어 -->
            <div class="filter-section">
                <h3>언어 의존도</h3>
                <label><input type="checkbox" name="language" value="텍스트 없음"> 텍스트 없음</label>
                <label><input type="checkbox" name="language" value="적음"> 적음</label>
                <label><input type="checkbox" name="language" value="보통"> 보통</label>
                <label><input type="checkbox" name="language" value="많음"> 많음</label>
            </div>

            <!-- 인원 -->
            <div class="filter-section">
                <h3>플레이 인원</h3>
                <label><input type="checkbox" name="minPlayers" value="1"> 1인 가능</label>
                <label><input type="checkbox" name="minPlayers" value="2"> 2인 가능</label>
                <label><input type="checkbox" name="minPlayers" value="3"> 3인</label>
                <label><input type="checkbox" name="minPlayers" value="4"> 4인</label>
            </div>

            <!-- 시간 -->
            <div class="filter-section">
                <h3>플레이 시간</h3>
                <label><input type="checkbox" name="maxTime" value="30"> 30분 이하</label>
                <label><input type="checkbox" name="maxTime" value="60"> 60분 이하</label>
                <label><input type="checkbox" name="maxTime" value="90"> 90분 이하</label>
                <label><input type="checkbox" name="maxTime" value="120"> 120분 이하</label>
            </div>

            <!-- 난이도 -->
            <div class="filter-section">
                <h3>난이도</h3>
                <label><input type="checkbox" name="maxWeight" value="2.0"> 2 이하</label>
                <label><input type="checkbox" name="maxWeight" value="3.0"> 3 이하</label>
                <label><input type="checkbox" name="maxWeight" value="4.0"> 4 이하</label>
            </div>

        </form>

        <!-- ================== 고정 영역 ================== -->
        <div class="filter-bottom-header">
            <h2>전체 보드게임</h2>

            <div class="top-controls">
                <form action="/games" method="get">
                    <input type="text" name="keyword" class="search-input" placeholder="게임 검색 (한국어 / 영어)">
                    <button class="search-btn">검색</button>

                    <select name="sort" class="sort-select">
                        <option value="rank">랭킹순</option>
                        <option value="new">최신순</option>
                        <option value="old">오래된순</option>
                        <option value="name">이름순</option>
                    </select>
                </form>
            </div>
        </div>

        <!-- ================== JS로 교체될 영역 ================== -->
        <div id="gamesListArea"
             th:replace="boardgames/boardgame-grid :: gridList(${games})">
        </div>

    </div>

    <script>
        // 🔥 체크박스 클릭만 해도 자동 검색
        document.querySelectorAll("#filterForm input[type='checkbox']")
            .forEach(cb => cb.addEventListener("change", applyFilter));

        // 🔥 필터 적용
        function applyFilter() {
            const form = document.getElementById("filterForm");
            const formData = new FormData(form);
            let params = new URLSearchParams(formData);

            fetch("/games/filter-api?" + params.toString())
                .then(res => res.json())
                .then(games => renderGameList(games));
        }

        // 🔥 초기화 버튼
        function resetFilters() {
            document.querySelectorAll("#filterForm input[type='checkbox']")
                .forEach(cb => cb.checked = false);

            applyFilter();
        }

        // 🔥 리스트 랜더링 (그리드만 바꾼다)
        function renderGameList(games) {

            let html = `
                <div class="game-grid">
                    ${games.map(g => `
                        <div class="game-card" onclick="location.href='/games/${g.id}'">
                            <div class="game-img-box">
                                <img src="${g.thumbnail}" onerror="this.src='/image/noimage.png'">
                            </div>
                            <div class="game-info">
                                <h3>${g.krName ?? g.name}</h3>
                                <p class="year">(${g.year})</p>
                            </div>
                        </div>
                    `).join("")}
                </div>
            `;

            document.getElementById("gamesListArea").innerHTML = html;
        }
    </script>

</div>
</html>
